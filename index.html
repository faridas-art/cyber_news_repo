<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberNews Aggregator - Latest Cybersecurity News</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #ffffff;
            line-height: 1.6;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2em;
            font-weight: bold;
            background: linear-gradient(45deg, #00d4ff, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .last-updated {
            color: #888;
            font-size: 0.9em;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }

        .filter-group h4 {
            color: #00d4ff;
            font-size: 0.9em;
            margin: 0;
            font-weight: 600;
        }

        .filter-group .filter-btn {
            margin: 0;
        }

        .filter-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .filter-btn:hover, .filter-btn.active {
            background: linear-gradient(45deg, #00d4ff, #ff6b6b);
            border-color: transparent;
        }

        .refresh-btn {
            padding: 12px 25px;
            background: linear-gradient(45deg, #00d4ff, #ff6b6b);
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #00d4ff;
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .news-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .news-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .confidence-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .confidence-high {
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            color: #000;
        }

        .confidence-medium {
            background: linear-gradient(45deg, #ffa726, #ff7043);
            color: #000;
        }

        .confidence-low {
            background: linear-gradient(45deg, #ff6b6b, #ff8a80);
            color: #fff;
        }

        .news-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #ffffff;
            line-height: 1.4;
        }

        .news-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #888;
            align-items: center;
        }

        .category-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .news-tldr {
            background: rgba(0, 212, 255, 0.1);
            border-left: 4px solid #00d4ff;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 15px;
            font-style: italic;
        }

        .expand-btn {
            background: transparent;
            border: 1px solid #00d4ff;
            color: #00d4ff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .expand-btn:hover {
            background: #00d4ff;
            color: #000;
        }

        .news-details {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .news-details.expanded {
            display: block;
        }

        .news-content {
            margin-bottom: 20px;
            line-height: 1.7;
        }

        .sources {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
        }

        .sources h4 {
            color: #00d4ff;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .source-list {
            list-style: none;
        }

        .source-list li {
            margin-bottom: 8px;
        }

        .source-list a {
            color: #00d4ff;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .source-list a:hover {
            color: #ff6b6b;
        }

        .no-news {
            text-align: center;
            padding: 50px;
            color: #888;
            font-size: 1.2em;
        }

        .stats {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #888;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .news-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .filter-group {
                min-width: auto;
                width: 100%;
                max-width: 300px;
            }

            .filter-group .filter-btn {
                width: 100%;
            }

            .stats {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">üõ°Ô∏è CyberNews Aggregator</div>
                <div class="last-updated" id="lastUpdated">Last updated: Never</div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalNews">0</div>
                <div class="stat-label">Total News</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highConfidence">0</div>
                <div class="stat-label">High Confidence</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="sources">0</div>
                <div class="stat-label">Sources Monitored</div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <h4>Confidence Level:</h4>
                <button class="filter-btn active" data-filter="all" data-type="confidence">All News</button>
                <button class="filter-btn" data-filter="high" data-type="confidence">High Confidence</button>
                <button class="filter-btn" data-filter="medium" data-type="confidence">Medium Confidence</button>
                <button class="filter-btn" data-filter="low" data-type="confidence">Low Confidence</button>
            </div>
            
            <div class="filter-group">
                <h4>Category:</h4>
                <button class="filter-btn" data-filter="all" data-type="category">All Categories</button>
                <button class="filter-btn" data-filter="general" data-type="category">General</button>
                <button class="filter-btn" data-filter="malware" data-type="category">Malware</button>
                <button class="filter-btn" data-filter="breach" data-type="category">Breach</button>
                <button class="filter-btn" data-filter="ransomware" data-type="category">Ransomware</button>
                <button class="filter-btn" data-filter="vulnerability" data-type="category">Vulnerability</button>
            </div>
            
            <button class="refresh-btn" onclick="refreshNews()">üîÑ Refresh News</button>
        </div>

        <!-- Diagnostics panel for troubleshooting network / deployment issues -->
        <div id="diagnostics" style="margin-top:20px; background: rgba(255,255,255,0.03); padding:12px; border-radius:8px;">
            <h4 style="color:#00d4ff; margin-bottom:8px;">Diagnostics</h4>
            <div style="color:#ccc; font-size:0.9em; margin-bottom:8px;">
                <div>Frontend URL: <span id="diag-frontend">-</span></div>
                <div>API Base URL: <span id="diag-api">-</span></div>
                <div>Location Hostname: <span id="diag-host">-</span></div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="filter-btn" onclick="diagPingApi()">Test /api/news</button>
                <button class="filter-btn" onclick="diagFetchStats()">Test /api/stats</button>
                <button class="filter-btn" onclick="clearCacheAndRetry()">Clear cache & Reload</button>
                <button class="filter-btn" onclick="showDemoNews()">Show demo news</button>
            </div>
            <div id="diag-output" style="margin-top:12px; color:#fff; font-size:0.9em;"></div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            üîç Scraping latest cybersecurity news...
        </div>

        <div id="newsContainer" class="news-grid">
            <!-- News cards will be populated here -->
        </div>

        <div id="noNews" class="no-news" style="display: none;">
            No news found. Try refreshing or check back later.
        </div>
    </main>

    

    <script>
        // News data structure
        let allNews = [];
        let filteredNews = [];
        let isLoading = false;
        let currentFilters = {
            confidence: 'all',
            category: 'all'
        };

        // API Configuration
        // Allow a deploy-time or runtime override by creating a small
        // `config.js` that sets `window.API_BASE_URL = 'https://your-backend.example'`
        // and including it before this script. This is useful when the
        // frontend is hosted on GitHub Pages (static) and the API runs elsewhere.
        // Fallbacks:
        // - If window.API_BASE_URL is set, use it.
        // - If opened via file://, default to http://localhost:3000 for local dev.
        // - Otherwise use window.location.origin (useful when frontend and backend share origin).
        // If a config was provided, validate it. Treat common placeholders as unset so
        // we don't attempt to call a non-existing hostname (causes console DNS errors).
        let providedApi = (typeof window.API_BASE_URL !== 'undefined') ? String(window.API_BASE_URL).trim() : '';
        if (providedApi) {
            const lower = providedApi.toLowerCase();
            // Common placeholder patterns used in examples
            const isPlaceholder = lower.includes('example') || lower.includes('your-backend') || lower === 'https://your-backend.example';
            if (isPlaceholder) {
                console.warn('Detected placeholder API URL in config.js ‚Äî ignoring it so demo mode can be used. Update config.js with your real backend URL to fetch live news.');
                providedApi = '';
            }
        }

        let API_BASE_URL = providedApi || window.location.origin;

        if (!API_BASE_URL || API_BASE_URL === 'null' || window.location.protocol === 'file:') {
            API_BASE_URL = 'http://localhost:3000';
        }

        // Demo fallback data (shown when no backend is configured or reachable).
        const DEMO_NEWS = [
            {
                id: 'demo-1',
                title: 'Demo: Coordinated Phishing Campaign Targets Enterprises',
                tldr: 'A simulated campaign demonstrates how attackers use credential harvesting.',
                content: 'This is demo content to show how the news cards will render when no backend is available. Deploy the API and set window.API_BASE_URL to see live data.',
                confidence: 'high',
                sources: 4,
                timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                category: 'general',
                references: [{ name: 'Demo Source', url: 'https://example.com' }]
            },
            {
                id: 'demo-2',
                title: 'Demo: New Ransomware Variant Targets OT Environments',
                tldr: 'Sample TL;DR of a ransomware story used for demonstration.',
                content: 'Demo content showing how full story and sources are presented in the UI.',
                confidence: 'medium',
                sources: 2,
                timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(),
                category: 'ransomware',
                references: [{ name: 'Demo Source 2', url: 'https://example.com' }]
            }
        ];

        // Show demo news when backend is not available or user requests it
        function showDemoNews() {
            allNews = DEMO_NEWS;
            applyCurrentFilters();
            renderNews();
            // Update stats locally from demo data
            document.getElementById('totalNews').textContent = allNews.length;
            document.getElementById('highConfidence').textContent = allNews.filter(n => n.confidence === 'high').length;
            document.getElementById('sources').textContent = new Set(allNews.flatMap(n => n.references.map(r => r.name))).size;
            updateLastUpdated(null);
        }

        // Initialize the app
        async function init() {
            console.log('Initializing CyberNews Aggregator...');
            console.log('API Base URL:', API_BASE_URL);
            
            try {
                await loadNews();
                setupEventListeners();
                await updateStats();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Failed to initialize app:', error);
                showError('Failed to initialize the application. Please refresh the page.');
            }
        }

        // Load news data from API
        async function loadNews() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            
            try {
                console.log('Loading news from API...');
                const response = await fetch(`${API_BASE_URL}/api/news`);

                if (!response.ok) {
                    // Provide a helpful hint when the API endpoint is missing (404)
                    if (response.status === 404) {
                        // If a custom API wasn't provided (e.g., on GitHub Pages), instruct the user
                        if (!window.API_BASE_URL) {
                            showError('API returned 404 ‚Äî no backend is available at this origin. For GitHub Pages, deploy the backend separately and create `config.js` that sets `window.API_BASE_URL` to your backend URL.');
                        } else {
                            showError('API returned 404 ‚Äî server not found. Check that the backend URL in your config is correct and reachable.');
                        }
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('News loaded:', result);
                
                if (result.success) {
                    allNews = result.data;
                    // Reset filters and apply current filter state
                    applyCurrentFilters();
                    renderNews();
                    updateLastUpdated(result.lastUpdated);
                    console.log(`Loaded ${allNews.length} news articles`);
                } else {
                    console.error('Failed to load news:', result.error);
                    showError('Failed to load news. Please try again.');
                }
            } catch (error) {
                console.error('Error loading news:', error);
                // If fetch failed because the server is not running or unreachable, show actionable message
                if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                    // If running on GitHub Pages or a static host, suggest using config.js or demo mode
                    if (window.location.hostname && window.location.hostname.endsWith('github.io') && !window.API_BASE_URL) {
                        showError('Could not reach API. On GitHub Pages you must run the backend elsewhere and set `window.API_BASE_URL` via a `config.js` file. Click "Show demo news" to preview the UI.');
                    } else if (window.API_BASE_URL && window.API_BASE_URL !== 'http://localhost:3000') {
                        showError(`Could not reach configured API at ${window.API_BASE_URL}. Check the backend deployment.`);
                    } else {
                        showError('Network error: Could not reach API. Is the server running? Start it with `npm start` and visit http://localhost:3000 (or set window.API_BASE_URL when deploying frontend separately).');
                    }
                } else {
                    showError(`Network error: ${error.message}`);
                }
            } finally {
                isLoading = false;
                showLoading(false);
            }
        }

        // Render news cards
        function renderNews() {
            const container = document.getElementById('newsContainer');
            const noNews = document.getElementById('noNews');
            
            if (filteredNews.length === 0) {
                container.style.display = 'none';
                noNews.style.display = 'block';
                return;
            }
            
            container.style.display = 'grid';
            noNews.style.display = 'none';
            
            container.innerHTML = filteredNews.map(news => `
                <div class="news-card">
                    <div class="news-header">
                        <div class="confidence-badge confidence-${news.confidence}">
                            ${news.confidence.toUpperCase()} (${news.sources} sources)
                        </div>
                    </div>
                    <h3 class="news-title">${news.title}</h3>
                    <div class="news-meta">
                        <span>üïí ${formatTime(news.timestamp)}</span>
                        <span class="category-badge">${news.category}</span>
                    </div>
                    <div class="news-tldr">
                        <strong>TL;DR:</strong> ${news.tldr}
                    </div>
                    <button class="expand-btn" onclick="toggleDetails('${news.id}')">
                        üìñ Read Full Story
                    </button>
                    <div class="news-details" id="details-${news.id}">
                        <div class="news-content">
                            ${news.content}
                        </div>
                        <div class="sources">
                            <h4>üìö Sources & References</h4>
                            <ul class="source-list">
                                ${news.references.map(ref => `
                                    <li><a href="${ref.url}" target="_blank" rel="noopener">${ref.name}</a></li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle news details
        function toggleDetails(newsId) {
            const details = document.getElementById(`details-${newsId}`);
            const button = details.previousElementSibling;
            
            if (details.classList.contains('expanded')) {
                details.classList.remove('expanded');
                button.textContent = 'üìñ Read Full Story';
            } else {
                details.classList.add('expanded');
                button.textContent = 'üìñ Hide Details';
            }
        }

        // Apply current filter state to news data
        function applyCurrentFilters() {
            filteredNews = allNews.filter(news => {
                const confidenceMatch = currentFilters.confidence === 'all' || news.confidence === currentFilters.confidence;
                const categoryMatch = currentFilters.category === 'all' || news.category === currentFilters.category;
                return confidenceMatch && categoryMatch;
            });
        }

        // Filter news by confidence level or category
        function filterNews(filterValue, filterType) {
            // Update current filters
            currentFilters[filterType] = filterValue;
            
            // Update button states
            const buttons = document.querySelectorAll(`[data-type="${filterType}"]`);
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Apply filters
            applyCurrentFilters();
            renderNews();
        }

        // Refresh news
        async function refreshNews() {
            if (isLoading) return;
            
            try {
                console.log('Refreshing news...');
                const response = await fetch(`${API_BASE_URL}/api/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Refresh response:', result);
                
                if (result.success) {
                    await loadNews();
                    await updateStats();
                } else {
                    console.error('Failed to refresh news:', result.error);
                    showError('Failed to refresh news. Please try again.');
                }
            } catch (error) {
                console.error('Error refreshing news:', error);
                showError(`Network error during refresh: ${error.message}`);
            }
        }

        // Update statistics from API
        async function updateStats() {
            try {
                const out = document.getElementById && document.getElementById('diag-output');
                if (out) out.textContent = 'Fetching /api/stats ...';

                const response = await fetch(`${API_BASE_URL}/api/stats`);

                // Read raw text first so we can show useful diagnostics on parse error
                const raw = await response.text();

                if (!response.ok) {
                    console.error(`/api/stats returned HTTP ${response.status}`);
                    if (out) out.textContent = `Error: /api/stats returned HTTP ${response.status} ${response.statusText}`;
                    return;
                }

                let result;
                try {
                    result = JSON.parse(raw);
                } catch (parseErr) {
                    console.error('Invalid JSON received from /api/stats:', raw);
                    if (out) out.textContent = `Invalid JSON from /api/stats: ${raw.substring(0, 300)}`;
                    return;
                }

                if (result && result.success) {
                    const stats = result.data;
                    document.getElementById('totalNews').textContent = stats.totalNews;
                    document.getElementById('highConfidence').textContent = stats.highConfidence;
                    document.getElementById('sources').textContent = stats.sources;
                    if (out) out.textContent = `/api/stats OK ‚Äî total: ${stats.totalNews}, sources: ${stats.sources}`;
                } else {
                    console.error('Unexpected /api/stats response:', result);
                    if (out) out.textContent = `Unexpected /api/stats response: ${JSON.stringify(result).substring(0,300)}`;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
                const out = document.getElementById && document.getElementById('diag-output');
                if (out) out.textContent = `Error updating stats: ${error && error.message ? error.message : error}`;
            }
        }

        // Update last updated time
        function updateLastUpdated(timestamp) {
            if (timestamp) {
                const date = new Date(timestamp);
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${date.toLocaleString()}`;
            } else {
                const now = new Date();
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${now.toLocaleString()}`;
            }
        }

        // Show/hide loading indicator
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const container = document.getElementById('newsContainer');
            
            if (show) {
                loading.style.display = 'block';
                container.style.display = 'none';
            } else {
                loading.style.display = 'none';
                container.style.display = 'grid';
            }
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('newsContainer');
            const noNews = document.getElementById('noNews');
            
            container.style.display = 'none';
            noNews.style.display = 'block';
            noNews.innerHTML = `‚ùå ${message}`;

            // If the error is related to missing backend on a static host, offer demo mode
            if ((message && message.toLowerCase().includes('github pages')) || (message && message.toLowerCase().includes('could not reach api')) || (message && message.toLowerCase().includes('no backend'))) {
                const btn = document.createElement('button');
                btn.className = 'refresh-btn';
                btn.textContent = 'Show demo news';
                btn.style.marginTop = '16px';
                btn.onclick = () => {
                    showDemoNews();
                };
                noNews.appendChild(document.createElement('br'));
                noNews.appendChild(btn);
            }
        }

        // Format timestamp
        function formatTime(timestamp) {
            try {
                const now = new Date();
                const articleDate = new Date(timestamp);
                
                // Check if the date is valid
                if (isNaN(articleDate.getTime())) {
                    return 'Unknown time';
                }
                
                const diff = now - articleDate;
                
                // Check if diff is valid
                if (isNaN(diff) || diff < 0) {
                    return 'Just now';
                }
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m ago`;
                } else if (minutes > 0) {
                    return `${minutes}m ago`;
                } else {
                    return 'Just now';
                }
            } catch (error) {
                console.error('Error formatting time:', error);
                return 'Unknown time';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filterValue = e.target.dataset.filter;
                    const filterType = e.target.dataset.type;
                    filterNews(filterValue, filterType);
                });
            });
        }

        // Diagnostics helpers
        function setDiagInfo() {
            document.getElementById('diag-frontend').textContent = window.location.href;
            document.getElementById('diag-api').textContent = API_BASE_URL;
            document.getElementById('diag-host').textContent = window.location.hostname || 'n/a';
        }

        async function diagPingApi() {
            const out = document.getElementById('diag-output');
            out.textContent = 'Pinging /api/news ...';
            try {
                const res = await fetch(`${API_BASE_URL}/api/news`, { method: 'GET' });
                out.textContent = `Status: ${res.status} ${res.statusText}`;
                if (res.ok) {
                    const json = await res.json();
                    out.textContent += ` ‚Äî success: ${json.success}, items: ${json.data?.length ?? 'n/a'}`;
                } else {
                    out.textContent += ` ‚Äî response not ok`;
                }
            } catch (err) {
                out.textContent = `Error: ${err.message}`;
            }
        }

        async function diagFetchStats() {
            const out = document.getElementById('diag-output');
            out.textContent = 'Fetching /api/stats ...';
            try {
                const res = await fetch(`${API_BASE_URL}/api/stats`, { method: 'GET' });
                out.textContent = `Status: ${res.status} ${res.statusText}`;
                if (res.ok) {
                    const json = await res.json();
                    out.textContent += ` ‚Äî success: ${json.success}`;
                } else {
                    out.textContent += ` ‚Äî response not ok`;
                }
            } catch (err) {
                out.textContent = `Error: ${err.message}`;
            }
        }

        function clearCacheAndRetry() {
            // Clear any localStorage API override and reload
            if (localStorage.getItem('API_BASE_URL')) localStorage.removeItem('API_BASE_URL');
            location.reload();
        }

        // Auto-refresh every 30 minutes
        setInterval(() => {
            if (!isLoading) {
                refreshNews();
            }
        }, 30 * 60 * 1000);

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setDiagInfo();
            init();
        });
    </script>
</body>
</html>
